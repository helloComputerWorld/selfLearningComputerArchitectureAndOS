# Chapter15. 파일 시스템

## 15-1 파일과 디렉터리

### 1. 파일

- 파일: 하드 디스크나 SSD와 같은 보조기억장치에 저장된 관련 정보의 집합을 의미
- 파일 속성과 유형: 파일에 관한 부가 정보
  - 유형: 운영체제가 인지하는 파일의 종류 / 같은 이름일지라도 유형이 다르면 실행 양사도 달라짐 / 확장자 (파일 유형을 알리기 위한 방법)
  - 크기: 파일의 현재 크기와 허용 가능한 최대 크기
  - 보호: 어떤 사용자가 해당 파일을 읽고, 쓰고, 실행할 수 있는지
  - 위치: 파일의 보조기억장치상의 현재 위치
- 파일을 다루는 모든 작업은 운영체제에 의해 이뤄짐 -> 파일 연산을 위한 시스템 호출 제공

### 2. 디렉터리

- 1단계 디렉터리: 하나의 디렉터리 아래에 모든 파일 존재 => 옛날 운영체제
- 트리 구조 디렉터리: 여러 계층을 가진 디렉터리
  - 최상위 디렉터리 === 루트 디렉터리 === 슬래시(/)로 표현
  - 경로: 디렉터리를 이용해 파일 위치, 파일 이름을 특정 짓는 정보
- 절대 경로와 상대 경로
  - 절대 경로: 모든 파일은 루트 디렉터리에서 자기 자신까지 이르는 고유한 경로
  - 상대 경로: 현재 디렉터리부터 시작하는 경로
- 운영체제에서 디렉터리 연산을 위한 시스템 호출 제공
- 디렉터리 엔트리
  - 티렉터리도 파일 -> 많은 운영체제에서는 디렉터를 '특별한 형태의 파일'로 간주함 / 디렉터리에 담겨 있는 대상과 관련된 정보를 담고 있음
  - 디렉터리는 보조기억장치에 테이블 형태의 정보로 저장됨
  - 디렉터리 엔트리(행)가 공통으로 포함하는 정보" 디렉터리에 포함된 대상의 이름, 그 대상이 보조기억장치 내에 저장된 위치를 유추할 수 있는 정보

## 15-2 파일 시스템

### 1. 파티셔닝과 포매팅

- 보조기억장치를 사용하려면 파티셔닝, 포매팅을 거쳐야 함
- 파티셔닝(partitioning)
  - 저장 장치의 논리적인 영역을 구획하는 작업을 의미
  - 하드 디스크나 SSD처럼 용량이 큰 저장 장치를 하나 이상의 논리적인 단위로 구획하는 것
  - 파티셔닝 작업을 통해 나누어진 영역 각각을 파티션(partition)이라고 함
- 포매팅(formatting)
  - 파일 시스템을 설정하여 어떤 방식으로 파일을 저장하고 관리할 것인지를 결정하고, 새로운 데이터를 쓸 준비를 하는 작업을 의미
  - 어떤 종류의 파일 시스템을 사용할지 결정됨
  - 파티션마다 다른 파일 시스템을 설정할 수 있음
- 포매팅과 파티셔닝이 동시에 진행되는 경우가 많고, 이미 포매팅까지 완료되어 판매되는 경우도 많음

### 2. 파일 할당 방법

- 운영체제는 파일과 디렉터리를 블록(block) 단위로 읽고 씀
- 하나의 파일이 보조기억장치에 저장될 때는 하나 이상의 블록에 걸쳐 저장됨
- 운영체제는 하나 이상의 섹터를 블록이라는 단위로 묶은 뒤 블록 단위로 파일과 디렉터리를 관리함 => 파일 시스템이 모든 섹터를 관리하기에는 개수가 너무 많고 크기도 작기 때문 (하드디스크 가장 작은 단위: 섹터)
- 파일을 보조기억장치에 할당하는 방법
  - 연속 할당(contiguous allocation)
    - 보조기억장치 내 연속적인 블록에 파일을 할당하는 방식
    - 연속으로 할당된 파일에 접근하기 위해서는 파일의 첫 번째 블록 주소와 블록 단위의 길이만 알면 됨
    - 디렉터리 엔트리에 파일 이름, 첫번째 블록 주소, 블록 단위의 길이를 명시
    - 장점: 구현이 단순함
    - 단점
      - 외부 단편화: 프로그램의 크기보다 분할의 크기가 작은 경우에는 해당 분할이 비어 있는데도 불구하고 프로그램을 적재하지 못하기 때문에 발생하는 현상
      - 내부 단편화: 프로그램의 크기보다 분할의 크기가 큰 경우 해당 분할에 프로그램을 적재하고 남는 현상
  - 불연속 할당
    - 연결 할당
      - 연속 할당의 문제를 해결할 수 있는 방식
      - 각 블록 일부에 다음 블록의 주소를 저장하여 각 블록이 다름 블록을 가리키는 형태로 할당하는 방식
      - 파일을 이루는 데이터를 연결 리스트로 관리
      - 파일이 여러 블록에 흩어져 저장되어도 무방(불연속 할당)
      - 디렉터리 엔트리에 이름, 첫 번째 블록 주소, 블록 단위의 길이 명시
      - 단점
        - 반드시 첫 번째 블록부터 하나씩 차례대로 읽어야 함
          - 파일의 중간 부분부터 접근하고 싶어도 반드시 파일의 첫 번째 블록부터 접근하여 차례대로 읽어야 함
          - 임의 접근 속도(random access, 파일 내 임의의 위치에 접근하는 속도)가 매우 느림
        - 하드웨어 고장이나 오류 발생 시 해당 블록 이후 블록은 접근할 수 없음
          - 하드웨어 고장이나 오류로 인해 파일을 이루는 블록에 하나라도 문제가 발생하면 그 블록 이후에 블록에 접근할 수 없음 => 하나의 블록 안에 파일 데이터와 다음 블록 주소가 모두 포함되어 있기 때문
        - 이를 해결하기 위해 FAT 파일 시스템 사용함 (연결 할당을 변형)
    - 색인 할당
      - 파일의 모든 블록 주소를 색인 블록(index block)이라는 하나의 블록에 모아 괄리하는 방식
      - 파일에 순차적으로 접근하고 싶다면 색인 블록에 저장된 주소에 차례대로 접근하면 됨
      - 연결 할당과 달리 파일 내 임의의 위치에 접근하기 쉬움
      - 색인 블록만 알면 해당 파일 데이터에 접근할 수 있음
      - 디렉터리 엔트리에 파일 이름, 색인 블록 주소를 명시
      - 색인 할당을 기반으로 만든 파일 시스템이 유닉스 파일 시스템

### 3. 파일 시스템

- FAT 파일 시스템: FAT를 이용하는 파일 시스템
  - USB 메모리, SD 카드 등의 저용량 저장 장치에 사용
  - 연결 할당의 단점을 보완한 파일 시스템
  - 파일 할당 테이블(FAT: File Allocation Table): 각 블록에 포함된 다음 블록의 주소들을 한데 모아 테이블로 관리
  - 디렉터리 엔트리는 파일 이름, 파일의 첫 번째 블록 주소가 명시
  - FAT는 파티션의 앞부분에 만들어짐
  - 하드 디스크의 한 파티션을 FAT 파일 시스템으로 포맷하면 해당 파티션이 구성됨(예약 영역, FAT 영역,루트 디렉터리 영역, 데이터 영역)
  - FAT는 하드 디스크 파티션의 시작 부분에 있지만, 실행하는 도중 FAT가 메모리에 캐시될 수 있음 => FAT가 메모리에 적재된 채 실행되면 기존 연결 할당보다 다음 블록 찾는 속도가 빨라짐 => 임의 접근의 성능이 개선됨
- 유닉스 파일 시스템
  - 유닉스 계열 운영체제에서 사용
  - 색인 할당 기반
  - i-node: 유닉스 파일 시스템에서의 색인 블록
    - 파일 속성 정보와 15개의 블록 주소가 저장될 수 있음
    - FAT 파일 시스템에서는 파일 속성 정보가 디렉터리 엔트리에 표현됨
  - 파일마다 i-node가 존재하고 i-node마다 번호가 부여되어 있음
  - i-node들은 파티션 내 특정 영역에 모여 있음(예약 영역, i-node 영역, 데이터 영역)
  - 디렉터리 엔트리는 파일 이름, i-node 번호로 구성
  - 문제
    - i-node의 크기는 유한함
    - 15개의 블록을 차지하는 파일까지 가리킬 수 있음
    - 그 이상을 차지하는 파일은 i-node 하나만으로 파일의 데이터 블록을 모두 가리킬 수 없음
  - 해결
    - 블록 주소 중 12개에는 직접 블록 주소를 저장
      - 처음 12개에는 파일 데이터가 저장된 블록 주소가 직접적으로 명시됨
      - 직접 블록(direct block): 파일 데이터가 저장된 블록
    - 충분하지 않다면 13번째 주소에 단일 간접 블록 주소를 저장
      - 단일 간접 블록(single indirect block): 파일 데이터가 저장된 블록이 아닌 파일 데이터를 저장한 블록 주소가 저장된 블록
    - 충분하지 않다면 14번째 주소에 이중 간접 블록 주소를 저장
      - 이중 간접 블록(double indirect block): 데이터 블록 주소를 저장하는 블록 주소가 저장된 블록을 의미
    - 충분하지 않다면 15번째 주소에 삼중 간접 블록 주소를 저장
      - 삼중 간접 블록 주소(triple indirect block): 이중 간접 블록 주소가 저장된 블록 주소
- 저널링 파일 시스템
  - 시스템 크래시가 발생하면 파일 시스템이 훼손될 수 있음
  - 저널링(journaling) 기법: 작업 로그를 통해 시스템 크래시가 발생했을 때 빠르게 복구하기 위한 방법
  - 파일 시스템을 변경하는 작업
    - 작업 직전 파티션의 로그 영역에 수행하는 작업(변경 사항)에 대한 로그를 남김
    - 로그를 남긴 후 작업을 수행
    - 작업이 끝났다면 로그를 삭제
  - 만약 작업을 하던 도중 시스템 크래시가 발생한다면, 파일 시스템 전체를 검사할 필요 없이 로그 영역에 남긴 로그만 검사해도 됨
  - 저널링 파일 시스템은 시스템 클래시가 발생한 직후에 로그 영역을 읽어 크래시가 발생한 당시 어떤 작업을 실행 중이었는지 알아낸 다음 해당 작업 완료함
- 마운트
  - 한 저장 장치의 파일 시스템에서 다른 저장 장치의 파일 시스템에 접근할 수 있도록 파일 시스템을 편입시키는 작업을 의미
